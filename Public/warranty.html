<script>
document.getElementById("warranty-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;

    // Build data EXACTLY matching server.js expected fields
    const data = {
        claimId: "",
        source: form.source.value.trim(),
        customerName: form.customerName.value.trim(),
        originalOrderNumber: form.originalOrderNumber.value.trim(),
        originalOrder: "",
        originalOrderDate: form.originalOrderDate.value || "",
        originalWarrantyNumber: form.originalWarrantyNumber.value.trim(),
        previousWarrantyDate: "",
        dateReceived: new Date().toISOString().split("T")[0],
        newOrderNumber: "",
        newWarrantyNumber: "",
        product: form.product.value.trim(),
        issueDescription: form.issueDescription.value.trim(),
        technicianAssigned: "",
        upc: form.upc.value.trim() || "",
        replacementTracking: "",
        status: "Submitted",
        customerPhone: form.customerPhone.value.trim(),
        customerEmail: form.customerEmail.value.trim(),
        customerAddress: form.customerAddress.value.trim(),
        notes: form.notes.value.trim()
    };

    // Switch automatically between local and Render
    const API_URL =
        location.hostname === "localhost"
            ? "http://localhost:4000/warranty"
            : "https://acs-warranty-api.onrender.com/warranty";

    // UI feedback
    const statusEl = document.getElementById("status");
    const submitBtn = document.getElementById("submitBtn");
    statusEl.textContent = "";
    statusEl.className = "status";
    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            statusEl.textContent = "✅ Warranty claim submitted successfully!";
            statusEl.classList.add("ok");
            form.reset();
        } else {
            statusEl.textContent = "⚠️ Failed to submit claim: " + (result.error || "Unknown error");
            statusEl.classList.add("error");
        }

    } catch (err) {
        statusEl.textContent = "⚠️ Network error — please try again.";
        statusEl.classList.add("error");
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Warranty Claim";
    }
});
</script>
